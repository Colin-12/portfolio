<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BI Dashboard - Superstore Sales | D3.js</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Poppins:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        :root {
            --primary: #0A2540;
            --accent: #007BFF;
            --bg-light: #f4f7f6;
            --card-bg: #ffffff;
            --text-main: #333333;
            --text-muted: #666666;
        }
        body {
            font-family: 'Open Sans', sans-serif;
            margin: 0; background-color: var(--bg-light); color: var(--text-main);
        }
        .header {
            background-color: var(--primary); color: white;
            padding: 1rem 5%; display: flex; justify-content: space-between; align-items: center;
        }
        .header h1 { margin: 0; font-family: 'Poppins', sans-serif; font-size: 1.5rem; }
        .back-btn {
            color: white; text-decoration: none; border: 1px solid white;
            padding: 6px 15px; border-radius: 5px; font-size: 0.9rem; transition: 0.3s;
        }
        .back-btn:hover { background-color: white; color: var(--primary); }
        
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        
        /* KPI Cards */
        .kpi-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem; margin-bottom: 2rem;
        }
        .kpi-card {
            background: var(--card-bg); padding: 1.5rem; border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 4px solid var(--accent);
        }
        .kpi-title { font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; font-weight: 600; margin-bottom: 0.5rem; }
        .kpi-value { font-size: 2rem; font-weight: 700; color: var(--primary); font-family: 'Poppins', sans-serif; }
        
        /* Charts Layout */
        .chart-row { display: flex; gap: 1.5rem; margin-bottom: 2rem; flex-wrap: wrap; }
        .chart-card {
            background: var(--card-bg); padding: 1.5rem; border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); flex: 1; min-width: 300px;
        }
        .chart-card.full-width { width: 100%; flex: 100%; }
        .chart-header { font-family: 'Poppins', sans-serif; font-size: 1.1rem; color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; }
        
        /* Tooltip */
        .tooltip {
            position: absolute; text-align: center; padding: 8px 12px; font-size: 0.85rem;
            background: rgba(10, 37, 64, 0.9); color: white; border-radius: 4px;
            pointer-events: none; opacity: 0; transition: opacity 0.2s; z-index: 10;
        }
        svg { width: 100%; height: 100%; }
    </style>
</head>
<body>

    <div class="header">
        <h1>ðŸ“Š Executive Dashboard - Superstore</h1>
        <a href="projet-2.html" class="back-btn">Retour Ã  l'Ã©tude</a>
    </div>

    <div class="container">
        <div class="chart-card" style="margin-bottom: 1.5rem;">
  <div class="chart-header">Filtres</div>
  <div style="display:flex; gap:12px; flex-wrap:wrap;">
    <label>
      <div style="font-size:0.85rem; color:#666; margin-bottom:6px;">AnnÃ©e</div>
      <select id="filter-year" style="padding:8px 10px; border-radius:6px; border:1px solid #ddd;"></select>
    </label>
    <label>
      <div style="font-size:0.85rem; color:#666; margin-bottom:6px;">RÃ©gion</div>
      <select id="filter-region" style="padding:8px 10px; border-radius:6px; border:1px solid #ddd;"></select>
    </label>
    <label>
      <div style="font-size:0.85rem; color:#666; margin-bottom:6px;">CatÃ©gorie</div>
      <select id="filter-category" style="padding:8px 10px; border-radius:6px; border:1px solid #ddd;"></select>
    </label>
  </div>
</div>
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-title">Chiffre d'Affaires Global</div>
                <div class="kpi-value" id="kpi-sales">$0</div>
            </div>
            <div class="kpi-card" style="border-left-color: #28a745;">
                <div class="kpi-title">Profit Total</div>
                <div class="kpi-value" id="kpi-profit">$0</div>
            </div>
            <div class="kpi-card" style="border-left-color: #17a2b8;">
                <div class="kpi-title">Panier Moyen (AOV)</div>
                <div class="kpi-value" id="kpi-aov">$0</div>
            </div>
            <div class="kpi-card" style="border-left-color: #ffc107;">
                <div class="kpi-title">Total Commandes</div>
                <div class="kpi-value" id="kpi-orders">0</div>
            </div>

            <div class="kpi-card" style="border-left-color: #6f42c1;">
              <div class="kpi-title">Taux de marge</div>
              <div class="kpi-value" id="kpi-margin-rate">0%</div>
            </div>
            
            <div class="kpi-card" style="border-left-color: #fd7e14;">
              <div class="kpi-title">Effort promotionnel</div>
              <div class="kpi-value" id="kpi-promo-effort">0%</div>
            </div>
            
        </div>

        <div class="chart-row">
            <div class="chart-card full-width">
                <div class="chart-header">Ã‰volution du CA par trimestre (Trend)</div>
                <div id="trend-chart" style="height: 300px;"></div>
            </div>
        </div>

        <div class="chart-row">
            <div class="chart-card" style="flex: 1.5;">
                <div class="chart-header">CA par CatÃ©gorie de Produits</div>
                <div id="bar-chart" style="height: 300px;"></div>
            </div>
            <div class="chart-card" style="flex: 1;">
                <div class="chart-header">RÃ©partition par RÃ©gion</div>
                <div id="donut-chart" style="height: 300px;"></div>
            </div>
        </div>
    </div>

    <div id="tooltip" class="tooltip"></div>

    <script>
  const tooltip = d3.select("#tooltip");
  const formatMoney = d3.format("$,.0f");
  const formatPct = d3.format(".1%");

  // --- Etat global ---
  let DATA = null;

  const defaultColors = d3.schemeTableau10;

  function setSelectOptions(selectEl, values, withAll=true, allLabel="Tous") {
    selectEl.innerHTML = "";
    if (withAll) {
      const opt = document.createElement("option");
      opt.value = "__ALL__";
      opt.textContent = allLabel;
      selectEl.appendChild(opt);
    }
    values.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      selectEl.appendChild(opt);
    });
  }

  function getFilters() {
    const year = document.getElementById("filter-year").value;
    const region = document.getElementById("filter-region").value;
    const category = document.getElementById("filter-category").value;
    return { year, region, category };
  }

  function applyFilters(records, f) {
    return records.filter(r => {
      const okYear = (f.year === "__ALL__") || (+r.year === +f.year);
      const okRegion = (f.region === "__ALL__") || (r.region === f.region);
      const okCat = (f.category === "__ALL__") || (r.category === f.category);
      return okYear && okRegion && okCat;
    });
  }

  function computeKpisFromAgg(rows) {
    const totalSales = d3.sum(rows, d => d.sales);
    const totalProfit = d3.sum(rows, d => d.profit);
    const totalOrders = d3.sum(rows, d => d.orders);
    const totalCustomers = d3.sum(rows, d => d.customers);
    const totalDiscount = d3.sum(rows, d => d.discount_amt);
    const totalBefore = d3.sum(rows, d => d.sales_before);

    const aov = totalOrders ? (totalSales / totalOrders) : 0;
    const marginRate = totalSales ? (totalProfit / totalSales) : 0;
    const promoEffort = totalBefore ? (totalDiscount / totalBefore) : 0;

    return { totalSales, totalProfit, totalOrders, totalCustomers, aov, marginRate, promoEffort };
  }

  function animateNumber(selector, value, formatter) {
    const node = d3.select(selector);
    node.transition().duration(900).tween("text", function() {
      const start = 0;
      const i = d3.interpolate(start, value);
      return function(t) { this.textContent = formatter(i(t)); };
    });
  }

  function renderKpis(k) {
    animateNumber("#kpi-sales", k.totalSales, v => formatMoney(v));
    animateNumber("#kpi-profit", k.totalProfit, v => formatMoney(v));
    animateNumber("#kpi-aov", k.aov, v => formatMoney(v));
    animateNumber("#kpi-orders", k.totalOrders, v => d3.format(",.0f")(v));
    animateNumber("#kpi-margin-rate", k.marginRate, v => formatPct(v));
    animateNumber("#kpi-promo-effort", k.promoEffort, v => formatPct(v));
  }

  function clearCharts() {
    d3.select("#trend-chart").selectAll("*").remove();
    d3.select("#bar-chart").selectAll("*").remove();
    d3.select("#donut-chart").selectAll("*").remove();
  }

  function renderTrend(rows) {
    // AgrÃ¨ge par mois
    const byMonth = d3.rollups(
      rows,
      v => d3.sum(v, d => d.sales),
      d => d.year_month
    ).map(([ym, sales]) => ({ ym, sales }));

    byMonth.sort((a,b) => d3.ascending(a.ym, b.ym));

    const container = document.getElementById("trend-chart");
    const margin = {top: 20, right: 30, bottom: 30, left: 60};
    const width = container.clientWidth - margin.left - margin.right;
    const height = 300 - margin.top - margin.bottom;

    const parseYM = d3.timeParse("%Y-%m");
    byMonth.forEach(d => d.date = parseYM(d.ym));

    const svg = d3.select("#trend-chart").append("svg")
      .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
      .append("g").attr("transform", `translate(${margin.left},${margin.top})`);

    const x = d3.scaleTime().domain(d3.extent(byMonth, d => d.date)).range([0, width]);
    const y = d3.scaleLinear().domain([0, d3.max(byMonth, d => d.sales)]).nice().range([height, 0]);

    svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x).ticks(8));
    svg.append("g").call(d3.axisLeft(y).ticks(5).tickFormat(d => "$" + (d/1000).toFixed(0) + "k"));

    svg.append("g").style("stroke-dasharray", "3,3").style("opacity", 0.1)
      .call(d3.axisLeft(y).tickSize(-width).tickFormat(""));

    const line = d3.line()
      .x(d => x(d.date))
      .y(d => y(d.sales))
      .curve(d3.curveMonotoneX);

    const path = svg.append("path").datum(byMonth)
      .attr("fill", "none")
      .attr("stroke", "#007BFF")
      .attr("stroke-width", 3)
      .attr("d", line);

    const totalLength = path.node().getTotalLength();
    path.attr("stroke-dasharray", totalLength + " " + totalLength)
      .attr("stroke-dashoffset", totalLength)
      .transition().duration(1200).ease(d3.easeLinear)
      .attr("stroke-dashoffset", 0);

    svg.selectAll("circle").data(byMonth).enter().append("circle")
      .attr("cx", d => x(d.date))
      .attr("cy", d => y(d.sales))
      .attr("r", 4)
      .attr("fill", "#0A2540")
      .on("mouseover", (event, d) => {
        tooltip.style("opacity", 1)
          .html(`<b>${d.ym}</b><br>${formatMoney(d.sales)}`)
          .style("left", (event.pageX + 10) + "px")
          .style("top", (event.pageY - 28) + "px");
        d3.select(event.currentTarget).attr("r", 7).attr("fill", "#007BFF");
      })
      .on("mouseout", (event) => {
        tooltip.style("opacity", 0);
        d3.select(event.currentTarget).attr("r", 4).attr("fill", "#0A2540");
      });
  }

  function renderBar(rows) {
    const byCat = d3.rollups(
      rows,
      v => d3.sum(v, d => d.sales),
      d => d.category
    ).map(([category, sales]) => ({ category, sales }));

    byCat.sort((a,b) => d3.ascending(a.sales, b.sales));

    const container = document.getElementById("bar-chart");
    const margin = {top: 20, right: 30, bottom: 40, left: 140};
    const width = container.clientWidth - margin.left - margin.right;
    const height = 300 - margin.top - margin.bottom;

    const svg = d3.select("#bar-chart").append("svg")
      .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
      .append("g").attr("transform", `translate(${margin.left},${margin.top})`);

    const x = d3.scaleLinear().domain([0, d3.max(byCat, d => d.sales)]).range([0, width]);
    const y = d3.scaleBand().domain(byCat.map(d => d.category)).range([height, 0]).padding(0.3);

    svg.append("g").attr("transform", `translate(0,${height})`)
      .call(d3.axisBottom(x).ticks(5).tickFormat(d => "$" + (d/1000).toFixed(0) + "k"));
    svg.append("g").call(d3.axisLeft(y));

    svg.selectAll("rect").data(byCat).enter().append("rect")
      .attr("y", d => y(d.category))
      .attr("x", 0)
      .attr("height", y.bandwidth())
      .attr("rx", 4)
      .attr("fill", "#0A2540")
      .attr("width", 0)
      .on("mousemove", (event, d) => {
        tooltip.style("opacity", 1)
          .html(`<b>${d.category}</b><br>${formatMoney(d.sales)}`)
          .style("left", (event.pageX + 10) + "px")
          .style("top", (event.pageY - 28) + "px");
      })
      .on("mouseout", () => tooltip.style("opacity", 0))
      .transition().duration(900)
      .attr("width", d => x(d.sales));

    svg.selectAll(".label").data(byCat).enter().append("text")
      .attr("y", d => y(d.category) + y.bandwidth() / 2 + 4)
      .attr("x", 6)
      .attr("fill", "white")
      .style("font-size", "12px")
      .style("font-weight", "bold")
      .text(d => formatMoney(d.sales))
      .style("opacity", 0)
      .transition().delay(700).style("opacity", 1);
  }

  function renderDonut(rows) {
    const byRegion = d3.rollups(
      rows,
      v => d3.sum(v, d => d.sales),
      d => d.region
    ).map(([region, sales]) => ({ region, sales }));

    byRegion.sort((a,b) => d3.descending(a.sales, b.sales));

    const container = document.getElementById("donut-chart");
    const width = container.clientWidth;
    const height = 300;
    const margin = 20;
    const radius = Math.min(width, height) / 2 - margin;

    const svg = d3.select("#donut-chart").append("svg")
      .attr("viewBox", `0 0 ${width} ${height}`)
      .append("g")
      .attr("transform", `translate(${width/2},${height/2})`);

    const color = d3.scaleOrdinal()
      .domain(byRegion.map(d => d.region))
      .range(defaultColors);

    const pie = d3.pie().value(d => d.sales);
    const data_ready = pie(byRegion);

    const arc = d3.arc().innerRadius(radius * 0.5).outerRadius(radius * 0.8);
    const arcHover = d3.arc().innerRadius(radius * 0.5).outerRadius(radius * 0.9);

    svg.selectAll("path").data(data_ready).enter().append("path")
      .attr("d", arc)
      .attr("fill", d => color(d.data.region))
      .attr("stroke", "white").style("stroke-width", "2px")
      .on("mouseover", function(event, d) {
        d3.select(this).transition().duration(150).attr("d", arcHover);
        tooltip.style("opacity", 1)
          .html(`<b>${d.data.region}</b><br>${formatMoney(d.data.sales)}`)
          .style("left", (event.pageX + 10) + "px")
          .style("top", (event.pageY - 28) + "px");
      })
      .on("mouseout", function() {
        d3.select(this).transition().duration(150).attr("d", arc);
        tooltip.style("opacity", 0);
      })
      .transition().duration(700)
      .attrTween("d", function(d) {
        const i = d3.interpolate({startAngle: 0, endAngle: 0}, d);
        return function(t) { return arc(i(t)); };
      });

    // --- Legend
    const legend = d3.select("#donut-chart").append("div")
      .style("display", "flex")
      .style("gap", "10px")
      .style("flex-wrap", "wrap")
      .style("margin-top", "8px")
      .style("font-size", "0.9rem")
      .style("color", "#444");

    byRegion.forEach(d => {
      const item = legend.append("div").style("display","flex").style("align-items","center").style("gap","6px");
      item.append("span")
        .style("width","12px").style("height","12px")
        .style("background", color(d.region))
        .style("display","inline-block").style("border-radius","3px");
      item.append("span").text(`${d.region}`);
    });
  }

  function renderAll() {
    const f = getFilters();
    const rows = applyFilters(DATA.agg, f);

    const k = computeKpisFromAgg(rows);
    renderKpis(k);

    clearCharts();
    renderTrend(rows);
    renderBar(rows);
    renderDonut(rows);
  }

  async function init() {
    // âš ï¸ Chemin relatif : adapte si besoin selon oÃ¹ est placÃ© ton fichier html
    DATA = await d3.json("data/dashboard_data.json");

    // Populate filters
    setSelectOptions(document.getElementById("filter-year"), DATA.filters.years.map(String), true, "Toutes");
    setSelectOptions(document.getElementById("filter-region"), DATA.filters.regions, true, "Toutes");
    setSelectOptions(document.getElementById("filter-category"), DATA.filters.categories, true, "Toutes");

    // Events
    ["filter-year","filter-region","filter-category"].forEach(id => {
      document.getElementById(id).addEventListener("change", renderAll);
    });

    renderAll();
  }

  init();

  // ResponsivitÃ©
  window.addEventListener("resize", () => {
    if (!DATA) return;
    renderAll();
  });
</script>
</body>
</html>
